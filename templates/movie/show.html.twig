{#{% extends 'base.html.twig' %}#}

{#{% block body %}#}
{#    <h1>Film</h1>#}

{#    <div class="d-flex flex-wrap gap-3">#}
{#        <div class="card" style="width: 200px;">#}
{#            <img src="https://image.tmdb.org/t/p/w500{{ movie.picture }}" alt="{{ movie.title }}" class="card-img-top">#}
{#            <div class="card-body">#}
{#                <h5 class="card-title">{{ movie.title }}</h5>#}
{#                {% for genre in movie.genres %}#}
{#                    <p> {{ genre }} </p>#}
{#                {% endfor %}#}
{#                <p>{{ movie.releaseDate ? movie.releaseDate|date('d/m/Y') : 'Date inconnue' }}</p>#}

{#                <p>Popularité : {{ movie.popularity }}</p>#}


{#                <p> Companies de production : </p>#}
{#                {% for productionCompanie in movie.productionCompanies %}#}
{#                    <p> {{ productionCompanie.name }}, ({{ productionCompanie.originCountry }}) </p>#}
{#                    {% if(productionCompanie.logo) %}#}
{#                    <img src="https://image.tmdb.org/t/p/w500{{ productionCompanie.logo }}" alt="{{ productionCompanie.name }}"#}
{#                         class="card-img-top">#}
{#                    {% endif %}#}
{#                {% endfor %}#}
{#                <small>{{ movie.resume|length > 100 ? movie.resume|slice(0, 100) ~ '...' : movie.resume }}</small>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#{% endblock %}#}
{% extends 'base.html.twig' %}

{% block body %}
    <div class="container pt-3">
        <a href="{{ path('app_movie_index') }}" class="btn btn-link mb-3 text-decoration-none text-black">&larr; Retour aux films</a>

        <div class="row g-4">
            <div class="col-12 col-md-4 col-lg-3">
                <div class="card bg-dark text-light h-100">
                    <img
                        src="https://image.tmdb.org/t/p/w500{{ movie.picture }}"
                        alt="{{ movie.title }}"
                        class="card-img-top"
                    >
                    <div class="card-body">
                        {% if movie.popularity is defined %}
                            <p class="mb-1">
                                <span class="badge bg-warning text-dark">
                                    ★ {{ movie.popularity|number_format(1, ',', ' ') }}
                                </span>
                            </p>
                        {% endif %}
                        <p class="mb-0 small text-muted">
                            Sortie :
                            {{ movie.releaseDate ? movie.releaseDate|date('d/m/Y') : 'Date inconnue' }}
                        </p>
                    </div>
                </div>
            </div>


            <div class="col-12 col-md-8 col-lg-9">
                <h1 class="mb-2">{{ movie.title }}</h1>

                {% if movie.genres is defined and movie.genres|length > 0 %}
                    <p class="mb-2">
                        {% for genre in movie.genres %}
                            <span class="badge bg-secondary me-1 mb-1">{{ genre }}</span>
                        {% endfor %}
                    </p>
                {% endif %}

                {% if movie.status is defined and movie.status %}
                    <p class=" mb-3">
                        Statut : <strong>{{ movie.status }}</strong>
                    </p>
                {% endif %}

                <h2 class="h5 mt-3">Synopsis</h2>
                <p class="lead">
                    {{ movie.resume ?: 'Aucun synopsis disponible pour ce film.' }}
                </p>

                {# Production companies #}
                {% if movie.productionCompanies is defined and movie.productionCompanies|length > 0 %}
                    <h2 class="h5 mt-4">Sociétés de production</h2>
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        {% for productionCompanie in movie.productionCompanies %}
                            <div class="col">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body d-flex align-items-center">
                                        {% if productionCompanie.logo %}
                                            <img
                                                src="https://image.tmdb.org/t/p/w200{{ productionCompanie.logo }}"
                                                alt="{{ productionCompanie.name }}"
                                                class="me-3"
                                                style="max-height: 60px; width: auto;"
                                            >
                                        {% endif %}
                                        <div>
                                            <h3 class="h6 mb-1">{{ productionCompanie.name }}</h3>
                                            {% if productionCompanie.originCountry %}
                                                <p class="mb-0 small text-muted">
                                                    Pays : {{ productionCompanie.originCountry }}
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}


                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#watchlistModal"
                    >
                        Ajouter à une liste
                    </button>

                    {#Modal#}
                    <div class="modal fade" id="watchlistModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content bg-dark text-light">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title">Ajouter à une liste</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Choisir une liste existante</label>
                                        <select id="watchlist-select" class="form-select bg-dark text-light">
                                            <option value="">Aucune</option>
                                            {% for list in watch_lists %}
                                                <option value="{{ list.id }}">{{ list.title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="text-center text-muted mb-2">ou</div>

                                    <div class="mb-3">
                                        <label class="form-label">Créer une nouvelle liste</label>
                                        <input type="text"
                                               id="new-watchlist-name"
                                               class="form-control bg-dark text-light"
                                               placeholder="Nom de la nouvelle liste">
                                    </div>
                                </div>
                                <div class="modal-footer border-0">
                                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
                                    <button type="button"
                                            class="btn btn-danger"
                                            id="btn-add-to-watchlist"
                                            data-base-url="{{ path('watchlist_add_item', { id: 0 })|replace({'0':'__ID__'}) }}"
                                            data-tmdb-id="{{ movie.tmdbId }}">
                                        Ajouter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const btn    = document.getElementById('btn-add-to-watchlist');
                            const select = document.getElementById('watchlist-select');
                            const input  = document.getElementById('new-watchlist-name');

                            if (!btn) return;

                            btn.addEventListener('click', async (e) => {
                                e.preventDefault();

                                const tmdbId    = btn.dataset.tmdbId;
                                const existingId = select.value;
                                const newName    = input.value.trim();

                                if (!existingId && !newName) {
                                    alert('Choisis une liste ou entre un nom.');
                                    return;
                                }

                                let url    = btn.dataset.baseUrl;
                                const listId = existingId || 0;
                                url = url.replace('__ID__', listId);

                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                        tmdbId: tmdbId,
                                        type: 'movie',
                                        newListName: existingId ? null : newName
                                    }),
                                });

                                const data = await response.json();
                                if (response.ok) {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('watchlistModal'));
                                    modal.hide();
                                    alert('Film ajouté à la liste !');
                                    if (data.createdListId) {
                                        location.reload();
                                    }
                                } else {
                                    alert('Erreur : ' + (data.error ?? 'inconnue'));
                                }
                            });
                        });
                    </script>
                </div>

            </div>
        </div>
    </div>
{% endblock %}
